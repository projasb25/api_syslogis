<?php

namespace App\Models\Repositories;

use Exception;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class IntegracionRepository
{
    public function getGuides()
    {
        return DB::select("select 
                gd.id_guide, gd.seg_code as CUD, gd.status, 
                gt.status as Estado, gt.motive as SubEstado, 
                vh.plate_number as Placa, 'Qayarix' as Courier,
                gt.date_created as Fecha, gd.date_updated, gd.client_name as NombreReceptor,
                gd.client_dni as IDReceptor, gd.client_barcode as TrackNumber
            from guide as gd
            join guide_tracking as gt on gt.id_guide = gd.id_guide and gt.id_guide_tracking = (select max(id_guide_tracking) from guide_tracking where id_guide = gt.id_guide)
            left join shipping_order as so on so.id_shipping_order = gt.id_shipping_order
            left join vehicle as vh on vh.id_vehicle = so.id_vehicle
            WHERE gd.id_organization IN (1,2,3) and gd.reportado_integracion = 0
            and gd.status IN ('CURSO', 'ENTREGADO', 'NO ENTREGADO')"
        );
        // and gd.id_guide in (104,121,138,93,94,97,99,110,111,114,116,127,128,131,133,144,145,148,150,92)
    }

    public function LogInsert($cud, $estado, $subEstado, $idpedido_detalle, $result, $request, $response)
    {
        DB::table('log_integration_ripley')->insert(
            [
                'cud' => $cud,
                'estado' => $estado,
                'subEstado' => $subEstado,
                'idpedido_detalle' => $idpedido_detalle,
                'result' => $result,
                'request' => json_encode($request),
                'response' => json_encode($response)
            ]
            );
    }
    
    public function updateReportado($id_guide)
    {
        DB::table('guide')->where('id_guide', $id_guide)->update(['reportado_integracion', 1]);
    }

    // public function getGuideOeschle()
    // {
    //     $data = Guide::where('id_corporation', 4)
    //         ->where('status','ENTREGADO')
    //         ->where('reportado_integracion', 0)
    //         ->get();
    //     return $data;
    // }

    public function updateReportadoOeschle($guides)
    {
        DB::beginTransaction();
        try {
            foreach ($guides as $key => $guide) {
                DB::table('guide')->where('id_guide', $guide->id_guide)->update(['reportado_integracion' => 1]);
            }
        } catch (Exception $e) {
            Log::warning("updateReportadoOeschle" . $e->getMessage());
            DB::rollback();
        }
        DB::commit();
    }

    public function LogInsertOechsle($result, $request, $response)
    {
        DB::table('log_integracion_oechsle')->insert(
            [
                'result' => $result,
                'response' => json_encode($response),
                'request' => json_encode($request)
            ]
            );
    }

    public function getTestRipley()
    {
        return DB::table('test_ripley')->get();
    }

    public function getIntegracionRipley()
    {
        return DB::select("select
            p.token as cud,
            CASE 
                WHEN pdep.idestado_pedido_detalle = 17 THEN 'NO ENTREGADO'
                WHEN pdep.idestado_pedido_detalle = 16 THEN 'ENTREGADO'
                WHEN pdep.idestado_pedido_detalle = 12 THEN 'CURSO'
            END AS estado,
            pdep.observaciones as subestado, vh.numero_placa, 'Qayarix' as courier,env.fecha, pd.contacto_nombre_descarga, pd.contacto_dni_descarga, p.nro_guia_sistema ,CONCAT('https://www.qayarix.com:4721/ripley/status?c=',pd.idpedido_detalle) AS url ,
            pd.idpedido_detalle
        from pedido p
        join pedido_detalle pd on pd.idpedido = p.idpedido and pd.idpedido_detalle = (select max(idpedido_detalle) from pedido_detalle pd2 where pd2.idpedido = p.idpedido)
        join pedido_detalle_estado_pedido_detalle as pdep on pdep.idpedido_detalle = pd.idpedido_detalle and pdep.idpedido_detalle_estado_pedido_detalle = (select max(idpedido_detalle_estado_pedido_detalle) from pedido_detalle_estado_pedido_detalle where idpedido_detalle = pd.idpedido_detalle)
        join envio as env on env.idenvio = pd.idenvio
        join vehiculo as vh on vh.idvehiculo = env.idvehiculo
        where p.token in (
            '0600050000836527420001',
            '0600050000837750720007',
            '0600050000837154130006',
            '0600050000837130780004',
            '0600050000835460040001',
            '0600050000834294530002',
            '0600050000856271170002',
            '0600050000856057340002',
            '0600050000856264550002',
            '0600050000856560850005',
            '0600050000856545540002',
            '0600050000855171020002',
            '0600050000856313120003',
            '0600050000856583800007',
            '0600050000856587550008',
            '0600050000856456160007',
            '0600050000856476210102',
            '0600050000856590280008',
            '0600050000856447560001',
            '0600050000855171910003',
            '0600050000856529890004',
            '0600050000856671400001',
            '0600050000856347340001',
            '0600050000856314410001',
            '0600050000856283390001',
            '0600050000856383850001',
            '0600050000856712810001',
            '0600050000855463890001',
            '0600050000856549490001',
            '0600050000856301970001',
            '0600050000856540970003',
            '0600050000856283430002',
            '0600050000856418060007',
            '0600050000856282130001',
            '0600050000856246830003',
            '0600050000856439420001',
            '0600050000856637070005',
            '0600050000856263450002',
            '0600050000856656010001',
            '0600050000856433150102',
            '0600050000856581250008',
            '0600050000856336330201',
            '0600050000856409090102',
            '0600050000856409080101',
            '0600050000856347670001',
            '0600050000856611090001',
            '0600050000856261930004',
            '0600050000856660840006',
            '0600050000856339150001',
            '0600050000856463910001',
            '0600050000856317900004',
            '0600050000855456020002',
            '0600050000854934330003',
            '0600050000855791920003',
            '0600050000856526030001',
            '0600050000855963790006',
            '0600050000855917120005',
            '0600050000855791920001',
            '0600050000856596350001',
            '0600050000856596240108',
            '0600050000853972080002',
            '0600050000856531900002',
            '0600050000856472960003',
            '0600050000856702380201',
            '0600050000856338530002',
            '0600050000854695570001',
            '0600050000856338530003',
            '0600050000856000620001',
            '0600050000855455020002',
            '0600050000856702380202',
            '0600050000854695570002',
            '0600050000856494740002',
            '0600050000856449180002',
            '0600050000856449180001',
            '0600050000856531860001',
            '0600050000856397120003',
            '0600050000856397120004',
            '0600050000856397120001',
            '0600050000856339500001',
            '0600050000856339500002',
            '0600050000856455730002',
            '0600050000856472960004',
            '0600050000856455730001',
            '0600050000856397120002',
            '0600050000856000620002',
            '0600050000856504750001',
            '0600050000856461360102',
            '0600050000856461360104',
            '0600050000856461360101',
            '0600050000856354090001',
            '0600050000856554100001',
            '0600050000856681500002',
            '0600050000856681500003',
            '0600050000856681500001',
            '0600050000855882360009',
            '0600050000856148810002',
            '0600050000856148810003',
            '0600050000856256660003',
            '0600050000856256710004',
            '0600050000856256710006',
            '0600050000856256660001',
            '0600050000856256660002',
            '0600050000856256710005',
            '0600050000856186090001',
            '0600050000856246250004',
            '0600050000856246250003',
            '0600050000856148810001',
            '0600050000856107280001',
            '0600050000856110310002',
            '0600050000855281400001',
            '0600050000855260500001',
            '0600050000855773000002',
            '0600050000855113170001',
            '0600050000854881000001',
            '0600050000856046530001',
            '0600050000855743310104',
            '0600050000856059910107',
            '0600050000856004290001',
            '0600050000855986050001',
            '0600050000855985770001',
            '0600050000855876400001',
            '0600050000855876400002',
            '0600050000855876400004',
            '0600050000855876400003',
            '0600050000855023270003',
            '0600050000855023270002',
            '0600050000854843410003',
            '0600050000855968690001',
            '0600050000855920570002',
            '0600050000855920570003',
            '0600050000855920570004',
            '0600050000855920570001',
            '0600050000855987640002',
            '0600050000855849190001',
            '0600050000855773000001',
            '0600050000855773000003',
            '0600050000855461710001',
            '0600050000855461710002',
            '0600050000855866100001',
            '0600050000855863940002',
            '0600050000855506510002',
            '0600050000855256120007',
            '0600050000855432380002',
            '0600050000855432380003',
            '0600050000855766980003',
            '0600050000855766980004',
            '0600050000855762280001',
            '0600050000855766980002',
            '0600050000855725990001',
            '0600050000855432380001',
            '0600050000855377440005',
            '0600050000855515650002',
            '0600050000855654940002',
            '0600050000855340580003',
            '0600050000854615090002',
            '0600050000854615090001',
            '0600050000855293220001',
            '0600050000855299430002',
            '0600050000855613530001',
            '0600050000855683780001',
            '0600050000855707580002',
            '0600050000855250900005',
            '0600050000855485320001',
            '0600050000855485530002',
            '0600050000855369170002',
            '0600050000855369170004',
            '0600050000855407870002',
            '0600050000855356730001',
            '0600050000855369170003',
            '0600050000855250900004',
            '0600050000855381220006',
            '0600050000855586810001',
            '0600050000855382380001',
            '0600050000855506510003',
            '0600050000855370380001',
            '0600050000854839560002',
            '0600050000855251720001',
            '0600050000855193070001',
            '0600050000855026030001',
            '0600050000854822520001',
            '0600050000854957550001',
            '0600050000855205320001',
            '0600050000855075650002',
            '0600050000854785390001',
            '0600050000855100260001',
            '0600050000854053950002',
            '0600050000855825560001',
            '0600050000854064210005',
            '0600050000854060260004',
            '0600050000855049060002',
            '0600050000855076680001',
            '0600050000856207860001',
            '0600050000855714440004',
            '0600050000854766910004',
            '0600050000855542280001',
            '0600050000855981280001',
            '0600050000855522780004',
            '0600050000855638070003',
            '0600050000856253750002',
            '0600050000856237450001',
            '0600050000855263450003',
            '0600050000855237530001',
            '0600050000854843990003',
            '0600050000854586450001',
            '0600050000855470870001',
            '0600050000855527260004',
            '0600050000855533680004',
            '0600050000855539930001',
            '0600050000855351590004',
            '0600050000855541450002',
            '0600050000855538200002',
            '0600050000855534880001',
            '0600050000854688750001',
            '0600050000854755620002',
            '0600050000854532940001',
            '0600050000854504810001',
            '0600050000854127360001',
            '0600050000854233780003',
            '0600050000853412860001',
            '0600050000852196270001',
            '0600050000828645580004',
            '0600050000828645400003',
            '0600050000828645320002',
            '0600050000828645170001',
            '0600050000828648500002',
            '0600050000828648530004',
            '0600050000828648510003',
            '0600050000826140410001',
            '0600050000826524290101',
            '0600050000826581740001',
            '0600050000826983540003',
            '0600050000827245460101',
            '0600050000826664730001',
            '0600050000826766480002',
            '0600050000827092970003',
            '0600050000826930330002',
            '0600050000826812660001',
            '0600050000827007230004',
            '0600050000827218000002',
            '0600050000826664830002',
            '0600050000826860000004',
            '0600050000826468170005',
            '0600050000826468150004',
            '0600050000826371060003',
            '0600050000826726750008',
            '0600050000826730110009',
            '0600050000826713830001',
            '0600050000826667300006',
            '0600050000826855640003',
            '0600050000826737360003',
            '0600050000826766300001',
            '0600050000827252820001',
            '0600050000827256430003',
            '0600050000827268430105',
            '0600050000827187500001',
            '0600050000827187540002',
            '0600050000827187540003',
            '0600050000827437500003',
            '0600050000826798270001',
            '0600050000827437240002',
            '0600050000826757080002',
            '0600050000826647860003',
            '0600050000826357370001',
            '0600050000826495830001',
            '0600050000825867450003',
            '0600050000825942130001',
            '0600050000826699280001',
            '0600050000826560900001',
            '0600050000826624300002',
            '0600050000826591820001',
            '0600050000826473080003',
            '0600050000825867450004',
            '0600050000826521990002',
            '0600050000825942130002',
            '0600050000826577060003',
            '0600050000826698790002',
            '0600050000825867450002',
            '0600050000826560900003',
            '0600050000826473240005',
            '0600050000825942130003',
            '0600050000826291230201',
            '0600050000824949020002',
            '0600050000825994340003',
            '0600050000825850660002',
            '0600050000825878100004',
            '0600050000825890440004',
            '0600050000825890440001',
            '0600050000825968000001',
            '0600050000825944670004',
            '0600050000825944670003',
            '0600050000825944670002',
            '0600050000825988640001',
            '0600050000825832280003',
            '0600050000825832280001',
            '0600050000825832280002',
            '0600050000825626740001',
            '0600050000825763550002',
            '0600050000825763550003',
            '0600050000825626740004',
            '0600050000825626740002',
            '0600050000825771860002',
            '0600050000825771860003',
            '0600050000825994340002',
            '0600050000825771860004',
            '0600050000825994340004',
            '0600050000825890440002',
            '0600050000825968000003',
            '0600050000825934340001',
            '0600050000825934340003',
            '0600050000825952160001',
            '0600050000825963450002',
            '0600050000825931470001',
            '0600050000825931470003',
            '0600050000825765240002',
            '0600050000825765240003',
            '0600050000825765240004',
            '0600050000826103640001',
            '0600050000825802200002',
            '0600050000825763550001',
            '0600050000825934340002',
            '0600050000825931470002',
            '0600050000825968000002',
            '0600050000825951100302',
            '0600050000825836600002',
            '0600050000825836600004',
            '0600050000825836600003',
            '0600050000825951100301',
            '0600050000825951100303',
            '0600050000825917260001',
            '0600050000847041920005',
            '0600050000825539560101',
            '0600050000825612780002',
            '0600050000825612780001',
            '0600050000825546550002',
            '0600050000825546550001',
            '0600050000825546550003',
            '0600050000825124050001',
            '0600050000825539560104',
            '0600050000825659310004',
            '0600050000825539560103',
            '0600050000825578150003',
            '0600050000825578150002',
            '0600050000825578150001',
            '0600050000825692400002',
            '0600050000825181410001',
            '0600050000825612780004',
            '0600050000825181410003',
            '0600050000825181410002',
            '0600050000825666190004',
            '0600050000825666190002',
            '0600050000825666190003',
            '0600050000825659310003',
            '0600050000825659310002',
            '0600050000825720380002',
            '0600050000825718040002',
            '0600050000825746260004',
            '0600050000825746260002',
            '0600050000825746260003',
            '0600050000825718040004',
            '0600050000825718040003',
            '0600050000825156630003',
            '0600050000825156630004',
            '0600050000825156630002',
            '0600050000824921010001',
            '0600050000824691430002',
            '0600050000824691430003',
            '0600050000824691430004',
            '0600050000824921010003',
            '0600050000843039560004',
            '0600050000840368690003',
            '0600050000839938370001',
            '0600050000839938370002',
            '0600050000839901850001'
            )
            group by p.token");
    }
    // where date(p.fecha) >= '2020-10-23' and p.idcliente in (108,5,109,112,113,115)

    public function checkReported($cud, $estado, $subestado, $idpedido_detalle)
    {
        return DB::table('log_integration_ripley')
            ->where('cud', $cud)
            ->where('estado', $estado)
            ->where('subEstado', $subestado)
            ->where('idpedido_detalle', $idpedido_detalle)
            ->where('result', 'SUCCESS')
            ->first();
    }
}